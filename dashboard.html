<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student Portal ‚Äî Dashboard</title>

  <style>
    :root{
      --bg:#f3f7ff;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#4d8bff;
      --accent-2:#7683ff;
      --glass: rgba(255,255,255,0.85);
      --shadow: 0 14px 40px rgba(14, 17, 30, 0.06);
      --success:#16a34a;
      --danger:#ef4444;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
    html,body{height:100%;background:radial-gradient(circle at 10% 10%, #eaf2ff 0%, #f8faff 45%, #fff 100%);color:#0f1724;}
    a{color:inherit;text-decoration:none}
    /* layout */
    .app {
      max-width:1200px;
      margin:28px auto;
      padding:18px;
      display:grid;
      grid-template-columns:260px 1fr;
      gap:18px;
      align-items:start;
    }

    /* NAV / SIDEBAR */
    .sidebar {
      background:var(--card);
      border-radius:14px;
      padding:16px;
      box-shadow:var(--shadow);
      border:1px solid rgba(15,23,42,0.04);
      height:calc(100vh - 96px);
      position:sticky; top:20px;
      display:flex; flex-direction:column; gap:14px;
    }

    .brand {
      display:flex; align-items:center; gap:10px; margin-bottom:6px;
    }
    .brand .logo {
      width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;
    }
    .brand .title {font-weight:700;font-size:16px;}

    .nav {
      display:flex; flex-direction:column; gap:6px; margin-top:8px;
    }
    .nav button {
      background:transparent; border:none; text-align:left; padding:10px; border-radius:10px; cursor:pointer; font-size:14px; color:#111827;
      display:flex; gap:10px; align-items:center;
    }
    .nav button.active { background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; box-shadow:0 10px 26px rgba(77,139,255,0.12); }

    .user {
      margin-top:auto; display:flex; gap:10px; align-items:center; padding-top:8px; border-top:1px solid rgba(15,23,42,0.04);
    }
    .user .avatar { width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#94a3ff,#7c93ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700; }
    .user .meta { font-size:13px; }
    .user .meta .name { font-weight:700; }
    .logout { margin-left:auto; background:transparent;border:1px solid rgba(15,23,42,0.06); padding:8px 10px; border-radius:10px; cursor:pointer; font-size:13px; }

    /* main content */
    .main {
      display:flex; flex-direction:column; gap:14px;
    }

    /* TOP NAV (new) */
    .top-nav {
      display:flex; gap:12px; align-items:center; background:transparent; padding:6px 8px;
      border-radius:10px; margin-bottom:6px;
    }
    .top-nav a{
      padding:8px 12px; border-radius:8px; text-decoration:none; color:var(--muted); font-weight:700;
      border:1px solid transparent;
    }
    .top-nav a:hover{ background:rgba(15,23,42,0.03); color:var(--accent); }
    .top-nav a.active{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; box-shadow:0 10px 26px rgba(77,139,255,0.08); }

    .alert {
      width:100%; border-radius:10px; border:1px solid rgba(77,139,255,0.12);
      background: linear-gradient(90deg,#4d8bff,#7683ff);
      color:#fff; padding:10px 12px; position:relative;
    }

    .top-cards { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .card { background:var(--card); border-radius:12px; padding:14px; box-shadow:var(--shadow); border:1px solid rgba(15,23,42,0.04); }
    .card h3 { font-size:14px; margin-bottom:8px; color:var(--muted); }
    .card .big { font-size:22px; font-weight:700; }

    /* grid below */
    .grid { display:grid; grid-template-columns: 1fr 380px; gap:12px; align-items:start; }

    .panel { background:var(--card); border-radius:12px; padding:14px; box-shadow:var(--shadow); border:1px solid rgba(15,23,42,0.04); }

    .subjects-list { display:flex; flex-direction:column; gap:10px; }
    .subject { padding:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid rgba(15,23,42,0.03); }
    .subject .left { display:flex; gap:10px; align-items:center; }
    .sub-badge { width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#c7d2fe,#a5b4fc); display:flex;align-items:center;justify-content:center;font-weight:700;color:#0f1724; }
    .subject .meta { font-size:13px; }
    .small { font-size:13px; color:var(--muted); }

    /* assignments list */
    .assign-list { display:flex; flex-direction:column; gap:8px; }
    .assign { display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; border:1px dashed rgba(15,23,42,0.03); }
    .assign .title { font-weight:600; }
    .assign .due { font-size:13px; color:var(--muted); }

    .status { padding:6px 8px; border-radius:999px; font-weight:600; font-size:12px; }
    .status.pending { background:#fff7ed; color:#92400e; border:1px solid rgba(249,115,22,0.06); }
    .status.submitted { background:#ecffe8; color:var(--success); border:1px solid rgba(16,185,129,0.06); }
    .status.late { background:#ffecec; color:var(--danger); border:1px solid rgba(239,68,68,0.06); }

    /* attendance & results */
    .attendance { display:flex; gap:12px; }
    .att-card { flex:1; padding:12px; border-radius:10px; background:linear-gradient(180deg,#f0f8ff,#fff); text-align:center; }
    .att-card .num { font-size:20px; font-weight:700; color:#0b1220; }

    .result-table { width:100%; border-collapse:collapse; margin-top:8px; }
    .result-table th, .result-table td { text-align:left; padding:8px; border-bottom:1px solid rgba(15,23,42,0.04); font-size:13px; }
    .result-grade { font-weight:700; }

    .notice { display:flex; gap:10px; align-items:flex-start; padding:10px; border-radius:8px; border:1px solid rgba(15,23,42,0.03); }

    /* responsive */
    @media (max-width:980px){
      .app { grid-template-columns: 1fr; padding:12px; }
      .sidebar { position:relative; height:auto; }
      .grid { grid-template-columns: 1fr; }
      .top-cards { grid-template-columns: repeat(1,1fr); }
      .top-nav { overflow:auto; -webkit-overflow-scrolling:touch; }
    }
  </style>
</head>
<body>

  <div class="app" role="application" aria-label="Student portal dashboard">
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="Main navigation">
      <div class="brand">
        <div class="logo">S</div>
        <div class="title">Student Portal</div>
      </div>

      <nav class="nav" role="navigation" aria-label="Sidebar">
        <button class="nav-btn active" data-view="overview">üè† Dashboard</button>
        <button class="nav-btn" data-view="subjects">üìö Subjects</button>
        <button class="nav-btn" data-view="assignments">üìù Assignments</button>
        <button class="nav-btn" data-view="attendance">üìä Attendance</button>
        <button class="nav-btn" data-view="results">üìà Results</button>
        <button class="nav-btn" data-view="profile">üë§ Profile</button>
        <button class="nav-btn" data-view="notices">üîî Notifications</button>
      </nav>

      <div class="user" role="region" aria-label="User info">
        <div class="avatar">
          <div class="avatar-inner avatar-initial" style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#94a3ff,#7c93ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;">S</div>
        </div>
        <div class="meta">
          <div class="name" id="student-name">Student</div>
          <div class="small" id="student-id">ID: -</div>
        </div>

        <button id="logout" class="logout" aria-label="Log out">Logout</button>
      </div>
    </aside>

    <!-- MAIN AREA -->
    <main class="main" id="main">

      <!-- TOP NAV (added) -->
      <nav class="top-nav" role="navigation" aria-label="Top navigation">
        <a href="login.html" class="">LogIn</a>
        <a href="home.html" class="active">Home</a>
        <a href="courses.html">Courses</a>
        <a href="attendance.html">Attendance</a>
        <a href="results.html">Results</a>
      </nav>

      <!-- ALERT (static, marquee removed) -->
      <div class="alert" role="status" aria-live="polite">
        üîî Important: Semester exams start on <strong>10th December</strong>. Hall tickets will be available from <strong>3rd December</strong>. Check the Exams tab for details.
      </div>

      <!-- Top quick stats -->
      <div class="top-cards" id="overview-cards">
        <div class="card">
          <h3>Current Semester</h3>
          <div class="big" id="sem-name">Semester 4</div>
          <div class="small">Academic year 2025</div>
        </div>

        <div class="card">
          <h3>Attendance</h3>
          <div class="big" id="att-percent">--%</div>
          <div class="small">Overall attendance</div>
        </div>

        <div class="card">
          <h3>Pending Assignments</h3>
          <div class="big" id="pending-count">0</div>
          <div class="small">Due soon</div>
        </div>
      </div>

      <!-- Two-column grid -->
      <div class="grid">

        <!-- Left: subjects & assignments -->
        <section class="panel" id="left-panel">
          <h3 style="margin-bottom:10px;">üìö Subjects</h3>

          <div class="subjects-list" id="subjects-list">
            <!-- Dynamically filled -->
          </div>

          <hr style="margin:12px 0; border:none; border-top:1px solid rgba(15,23,42,0.04)" />

          <h3 style="margin-bottom:10px;">üìù Upcoming Assignments</h3>
          <div class="assign-list" id="assign-list">
            <!-- Dynamically filled -->
          </div>
        </section>

        <!-- Right: attendance, results, quick notices -->
        <aside class="panel" id="right-panel">
          <h3>üìä Attendance Summary</h3>
          <div class="attendance" style="margin-top:10px;">
            <div class="att-card">
              <div class="small">Present</div>
              <div class="num" id="att-present">0</div>
            </div>
            <div class="att-card">
              <div class="small">Absent</div>
              <div class="num" id="att-absent">0</div>
            </div>
            <div class="att-card">
              <div class="small">Late</div>
              <div class="num" id="att-late">0</div>
            </div>
          </div>

          <hr style="margin:12px 0;" />

          <h3>üèÖ Recent Results</h3>
          <table class="result-table" id="results-table" aria-label="Recent results table">
            <thead>
              <tr><th>Subject</th><th>Exam</th><th>Grade</th></tr>
            </thead>
            <tbody>
              <!-- filled by JS -->
            </tbody>
          </table>

          <hr style="margin:12px 0;" />

          <h3>üîî Notices</h3>
          <div id="notices" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
            <!-- filled by JS -->
          </div>
        </aside>
      </div>

    </main>
  </div>

  <script>
  // -- Dashboard logic (improved & compatibility shim) --
  (function () {
    const STORAGE_KEY = 'studentPortalData';

    // Read session from multiple possible locations / keys.
    function readSession() {
      try {
        const ls = localStorage.getItem('studentPortalSession');
        if (ls) {
          try { return JSON.parse(ls); } catch (e) { return null; }
        }
        const ss = sessionStorage.getItem('studentPortalSession');
        if (ss) {
          try { return JSON.parse(ss); } catch (e) { return null; }
        }
        const legacy = localStorage.getItem('plotpilotUser');
        if (legacy) {
          try {
            const parsed = JSON.parse(legacy);
            if (parsed && typeof parsed === 'object') {
              const sessionObj = {
                username: parsed.username || parsed.name || parsed.user || parsed.email || parsed.emailAddress || parsed.email || '',
                email: parsed.email || parsed.emailAddress || '',
                studentId: parsed.studentId || parsed.id || ''
              };
              localStorage.setItem('studentPortalSession', JSON.stringify(sessionObj));
              sessionStorage.setItem('studentPortalSession', JSON.stringify(sessionObj));
              return sessionObj;
            }
          } catch (e) {
            const sessionObj = { username: legacy, email: '', studentId: '' };
            localStorage.setItem('studentPortalSession', JSON.stringify(sessionObj));
            sessionStorage.setItem('studentPortalSession', JSON.stringify(sessionObj));
            return sessionObj;
          }
        }
        const legacyName = localStorage.getItem('plotpilotUserName') || localStorage.getItem('plotpilot_user');
        const legacyEmail = localStorage.getItem('plotpilotUserEmail') || localStorage.getItem('plotpilot_user_email');
        if (legacyName || legacyEmail) {
          const sessionObj = { username: legacyName || legacyEmail || 'Student', email: legacyEmail || '', studentId: '' };
          localStorage.setItem('studentPortalSession', JSON.stringify(sessionObj));
          sessionStorage.setItem('studentPortalSession', JSON.stringify(sessionObj));
          return sessionObj;
        }
        return null;
      } catch (e) {
        console.warn('readSession error', e);
        return null;
      }
    }

    const session = readSession();
    if (!session || !session.username) {
      try {
        const currentPath = (location.pathname || '').toLowerCase();
        const isLoginPage = currentPath.endsWith('login.html') || currentPath.endsWith('/login') || /login(\.html)?$/.test(currentPath);
        if (!isLoginPage) window.location.href = 'login.html';
      } catch (e) {
        window.location.href = 'login.html';
      }
      return;
    }

    const studentNameEl = document.getElementById('student-name');
    const studentIdEl = document.getElementById('student-id');
    const avatarInitial = document.querySelector('.avatar-initial');
    const logoutBtn = document.getElementById('logout');

    const displayName = (session.username || session.email || 'Student');
    try {
      if (studentNameEl) studentNameEl.textContent = displayName;
      if (studentIdEl) studentIdEl.textContent = session.studentId ? 'ID: ' + session.studentId : 'ID: -';
      if (avatarInitial && displayName && displayName.length > 0) avatarInitial.textContent = displayName[0].toUpperCase();
    } catch (e) {
      console.warn('Error writing user UI', e);
    }

    function getData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch (e) {
        return null;
      }
    }
    function saveData(data) {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) { console.warn(e); }
    }

    let data = getData();
    if (!data) {
      data = {
        semester: 'Semester 4',
        attendance: { present: 92, absent: 6, late: 2 },
        subjects: [
          { code: 'CS401', name: 'Data Structures', instructor: 'Dr. Rao', credits: 4 },
          { code: 'CS402', name: 'Database Systems', instructor: 'Prof. Iyer', credits: 3 },
          { code: 'CS403', name: 'Operating Systems', instructor: 'Dr. Mehta', credits: 4 },
          { code: 'CS404', name: 'Computer Networks', instructor: 'Prof. Singh', credits: 3 },
          { code: 'CS405', name: 'Software Engineering', instructor: 'Dr. Patel', credits: 3 }
        ],
        assignments: [
          { id: 1, title: 'DS - Assignment 3', subject: 'Data Structures', due: '2025-12-02', status: 'pending' },
          { id: 2, title: 'DB - Mini project', subject: 'Database Systems', due: '2025-12-08', status: 'pending' },
          { id: 3, title: 'OS - Lab report', subject: 'Operating Systems', due: '2025-11-26', status: 'submitted' }
        ],
        results: [
          { subject: 'Data Structures', exam: 'Midterm', grade: 'A' },
          { subject: 'Database Systems', exam: 'Midterm', grade: 'A-' },
          { subject: 'Operating Systems', exam: 'Midterm', grade: 'B+' }
        ],
        notices: [
          { id: 1, text: 'Semester exams start on 10th December. Hall tickets from 3rd Dec.' },
          { id: 2, text: 'Library will be closed on 29th Nov for inventory.' }
        ]
      };
      saveData(data);
    }

    try {
      const semEl = document.getElementById('sem-name');
      if (semEl) semEl.textContent = data.semester;

      const attPercent = Math.round((data.attendance.present / (data.attendance.present + data.attendance.absent + data.attendance.late)) * 100);
      const attEl = document.getElementById('att-percent');
      if (attEl) attEl.textContent = isNaN(attPercent) ? '0%' : (attPercent + '%');

      const pendingEl = document.getElementById('pending-count');
      if (pendingEl) pendingEl.textContent = data.assignments.filter(a => a.status === 'pending').length;
    } catch (e) {
      console.warn('Overview populate error', e);
    }

    (function renderSubjects() {
      const subjectsList = document.getElementById('subjects-list');
      if (!subjectsList) return;
      subjectsList.innerHTML = '';
      data.subjects.forEach(s => {
        const div = document.createElement('div');
        div.className = 'subject';
        const badgeText = (s.code || '').slice(0, 2).toUpperCase();
        div.innerHTML = `
          <div class="left">
            <div class="sub-badge">${badgeText}</div>
            <div>
              <div style="font-weight:700">${s.name}</div>
              <div class="small">${s.instructor} ¬∑ ${s.credits} credits</div>
            </div>
          </div>
          <div class="small">View</div>
        `;
        subjectsList.appendChild(div);
      });
    })();

    (function renderAssignments() {
      const assignList = document.getElementById('assign-list');
      if (!assignList) return;
      assignList.innerHTML = '';
      data.assignments.forEach(a => {
        const div = document.createElement('div');
        div.className = 'assign';
        const statusClass = a.status === 'pending' ? 'pending' : (a.status === 'submitted' ? 'submitted' : 'late');
        div.innerHTML = `
          <div style="flex:1">
            <div class="title">${a.title}</div>
            <div class="due small">Subject: ${a.subject} ¬∑ Due: ${a.due}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
            <div class="status ${statusClass}">${a.status}</div>
            <button class="small" data-id="${a.id}" style="background:transparent;border:none;color:var(--accent);cursor:pointer">Open</button>
          </div>
        `;
        assignList.appendChild(div);
      });

      assignList.querySelectorAll('button[data-id]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = parseInt(btn.getAttribute('data-id'), 10);
          viewAssignment(id);
        });
      });
    })();

    (function renderAttendance() {
      const present = document.getElementById('att-present');
      const absent = document.getElementById('att-absent');
      const late = document.getElementById('att-late');
      if (present) present.textContent = data.attendance.present + '%';
      if (absent) absent.textContent = data.attendance.absent + '%';
      if (late) late.textContent = data.attendance.late + '%';
    })();

    (function renderResults() {
      const tbody = document.querySelector('#results-table tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      data.results.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.subject}</td><td>${r.exam}</td><td class="result-grade">${r.grade}</td>`;
        tbody.appendChild(tr);
      });
    })();

    (function renderNotices() {
      const noticesEl = document.getElementById('notices');
      if (!noticesEl) return;
      noticesEl.innerHTML = '';
      data.notices.forEach(n => {
        const div = document.createElement('div');
        div.className = 'notice';
        div.innerHTML = `<div style="flex:1">${n.text}</div><div class="small" style="color:var(--muted)">‚Äî notice</div>`;
        noticesEl.appendChild(div);
      });
    })();

    (function setupNavigation() {
      const navBtns = document.querySelectorAll('.nav-btn');
      if (!navBtns || navBtns.length === 0) return;
      navBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          navBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const view = btn.getAttribute('data-view');
          switchView(view);
        });
      });
    })();

    function switchView(view) {
      const left = document.getElementById('left-panel');
      const right = document.getElementById('right-panel');
      if (!left || !right) return;
      if (view === 'overview') {
        left.querySelector('h3').textContent = 'üìö Subjects';
        left.style.display = 'block';
        right.style.display = 'block';
      } else if (view === 'subjects') {
        left.querySelector('h3').textContent = 'üìö Subjects';
        left.style.display = 'block';
        right.style.display = 'none';
      } else if (view === 'assignments') {
        left.querySelector('h3').textContent = 'üìù Assignments';
        left.style.display = 'block';
        right.style.display = 'none';
      } else if (view === 'attendance') {
        left.style.display = 'none';
        right.style.display = 'block';
      } else if (view === 'results') {
        left.style.display = 'none';
        right.style.display = 'block';
      } else if (view === 'profile') {
        left.style.display = 'none';
        right.style.display = 'block';
        right.innerHTML = `
          <h3>üë§ Profile</h3>
          <div style="margin-top:12px;">
            <p><strong>Name:</strong> ${displayName}</p>
            <p><strong>Email:</strong> ${session.email || '‚Äî'}</p>
            <p><strong>Student ID:</strong> ${session.studentId || '‚Äî'}</p>
          </div>
        `;
      } else if (view === 'notices') {
        left.style.display = 'none';
        right.style.display = 'block';
        right.innerHTML = `
          <h3>üîî Notifications</h3>
          <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
            ${data.notices.map(n => `<div class="notice">${n.text}</div>`).join('')}
          </div>
        `;
      }
    }

    function viewAssignment(id) {
      const a = data.assignments.find(x => x.id === id);
      if (!a) return alert('Assignment not found.');
      const detail = `Title: ${a.title}\nSubject: ${a.subject}\nDue: ${a.due}\nStatus: ${a.status}\n\nOpen assignment page to submit work (not implemented in demo).`;
      alert(detail);
    }
    window.viewAssignment = viewAssignment;

    if (logoutBtn) {
      logoutBtn.addEventListener('click', function () {
        try {
          localStorage.removeItem('studentPortalSession');
          sessionStorage.removeItem('studentPortalSession');
          localStorage.removeItem('plotpilotUser');
        } catch (e) { /* ignore */ }
        window.location.href = 'login.html';
      });
    }

    function refreshCounts() {
      const pending = data.assignments.filter(a => a.status === 'pending').length;
      const pendingEl = document.getElementById('pending-count');
      if (pendingEl) pendingEl.textContent = pending;
    }

    (function normalizeDueDates() {
      const today = new Date().toISOString().slice(0, 10);
      let changed = false;
      data.assignments.forEach(a => {
        if (a.status === 'pending' && a.due && a.due < today) {
          a.status = 'late';
          changed = true;
        }
      });
      if (changed) saveData(data);
      refreshCounts();
    })();

  })();
</script>

</body>
</html>
